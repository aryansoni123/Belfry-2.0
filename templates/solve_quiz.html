{% extends "base.html" %}

{% block title %}Solve: {{ quiz.title }} - Belfry{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<style>
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ea580c;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .test-result-item {
        transition: all 0.3s ease;
    }
    .test-result-item:hover {
        transform: translateX(4px);
    }
    .CodeMirror {
        height: 400px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
    }
    .CodeMirror-focused {
        border-color: #ea580c;
        box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <a href="{{ url_for('student.dashboard') }}" class="text-gray-600 hover:text-gray-900 font-medium transition">← Back to Dashboard</a>
        {% if previous_submission %}
            {% if previous_submission.status == 'pass' %}
                <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">Previously Passed</span>
            {% else %}
                <span class="bg-red-100 text-red-800 px-4 py-2 rounded-full text-sm font-semibold">Previous Attempt Failed</span>
            {% endif %}
        {% endif %}
    </div>
    
    <h1 class="text-4xl font-bold text-gray-900 mb-2">{{ quiz.title }}</h1>
    <p class="text-gray-600 mb-8">{{ quiz.description or 'Solve this coding problem' }}</p>
    
    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Problem Statement -->
        <div class="card p-6 max-h-[calc(100vh-200px)] overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Problem Statement</h2>
            <div class="prose max-w-none text-gray-700 whitespace-pre-wrap mb-6 leading-relaxed">{{ quiz.problem_statement }}</div>
            
            {% if quiz.function_signature %}
            <div class="mt-6 p-4 rounded-lg" style="background: rgba(170, 175, 203, 0.1); border-left: 4px solid #AAAFCB;">
                <h3 class="font-semibold mb-2" style="color: #5F4B35;">Function Signature:</h3>
                <pre class="text-sm bg-gray-900 text-green-400 p-3 rounded border code-editor overflow-x-auto">{{ quiz.function_signature }}</pre>
                <p class="text-xs mt-2 mb-3" style="color: #918E46;">Implement this function. Do not change the function signature.</p>
                <details class="text-xs">
                    <summary class="font-medium cursor-pointer hover:opacity-80" style="color: #5F4B35;">Code Format Example</summary>
                    <div class="mt-3 p-3 bg-white rounded border" style="border-color: #AAAFCB;">
                        <p class="font-semibold mb-2" style="color: #5F4B35;">Correct Format:</p>
                        <pre class="text-xs bg-gray-900 text-green-400 p-2 rounded overflow-x-auto">from typing import List

{{ quiz.function_signature }}
    # Your solution here
    return result  # Return, don't print!</pre>
                        <p class="text-red-700 font-semibold mt-3 mb-2">Don't Do This:</p>
                        <ul class="space-y-1 list-disc list-inside" style="color: #918E46;">
                            <li>Don't add <code class="bg-gray-100 px-1 rounded">if __name__ == "__main__":</code></li>
                            <li>Don't use <code class="bg-gray-100 px-1 rounded">input()</code> or <code class="bg-gray-100 px-1 rounded">print()</code></li>
                            <li>Don't change the function name or parameters</li>
                        </ul>
                    </div>
                </details>
            </div>
            {% endif %}
            
            {% if quiz.constraints %}
            <div class="mt-6 p-4 bg-amber-50 border-l-4 border-amber-500 rounded-lg">
                <h3 class="font-semibold text-amber-900 mb-2">Constraints:</h3>
                <p class="text-sm text-amber-800 whitespace-pre-wrap leading-relaxed">{{ quiz.constraints }}</p>
            </div>
            {% endif %}
            
            {% if sample_testcases %}
            <div class="mt-6">
                <h3 class="font-semibold text-gray-900 mb-4">Example:</h3>
                {% for testcase in sample_testcases %}
                <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="mb-3">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Input:</p>
                        <pre class="text-sm bg-gray-900 text-green-400 p-3 rounded border code-editor overflow-x-auto">{{ testcase.input_data }}</pre>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Output:</p>
                        <pre class="text-sm bg-gray-900 text-green-400 p-3 rounded border code-editor overflow-x-auto">{{ testcase.expected_output }}</pre>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Code Editor and Results -->
        <div class="flex flex-col">
            <!-- Code Editor -->
            <div class="card p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Code Editor</h2>
                    <select id="language" class="input-field text-sm w-32">
                        <option value="python">Python 3</option>
                    </select>
                </div>
                
                <textarea id="code-editor" style="display: none;">{% if previous_submission %}{{ previous_submission.code }}{% elif quiz.function_signature %}{{ quiz.function_signature }}
    # Your code here{% else %}# Write your Python code here
# Read input using input()
# Print output using print(){% endif %}</textarea>
                
                <div class="mt-4 flex space-x-3 items-center">
                    <button id="run-btn" 
                            class="btn-primary flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="run-spinner" class="spinner hidden"></span>
                        <span id="run-btn-text">▶ Run</span>
                    </button>
                    <button id="submit-btn" 
                            class="btn-primary flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="submit-spinner" class="spinner hidden"></span>
                        <span id="submit-btn-text">Submit</span>
                    </button>
                    <div class="flex-1"></div>
                    <span class="text-xs text-gray-500">Ctrl+Enter: Run | Ctrl+S: Submit</span>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div id="results-panel" class="card p-6 hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Results</h3>
                
                <!-- Console Output -->
                <div id="console-output" class="bg-gray-50 border border-gray-200 rounded-lg p-4 min-h-32 max-h-64 overflow-y-auto mb-4">
                    <p class="text-gray-500 text-sm">Run your code to see output here...</p>
                </div>
                
                <!-- Test Case Results -->
                <div id="testcases-output" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Test case results will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script>
const quizId = {{ quiz.id }};
const sampleTestcases = {{ sample_testcases_json | safe }};
let isRunning = false;
let isSubmitting = false;
let editor;

// Initialize CodeMirror
editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
    lineNumbers: true,
    mode: 'python',
    theme: 'monokai',
    indentUnit: 4,
    indentWithTabs: false,
    tabSize: 4,
    lineWrapping: true,
    autofocus: true,
    extraKeys: {
        "Tab": function(cm) {
            if (cm.somethingSelected()) {
                // Indent selected lines
                cm.indentSelection("add");
            } else {
                // Insert 4 spaces
                cm.replaceSelection("    ", "end");
            }
        },
        "Shift-Tab": function(cm) {
            // Unindent
            cm.indentSelection("subtract");
        },
        "Ctrl-Enter": function(cm) {
            runCode();
        },
        "Ctrl-S": function(cm) {
            submitCode();
            return false;
        }
    }
});

// Get code from editor
function getCode() {
    return editor.getValue();
}

// Show/hide loading states
function setLoading(button, isLoading) {
    const btn = document.getElementById(button + '-btn');
    const spinner = document.getElementById(button + '-spinner');
    const text = document.getElementById(button + '-btn-text');
    
    if (isLoading) {
        btn.disabled = true;
        spinner.classList.remove('hidden');
        if (button === 'run') {
            text.textContent = 'Running...';
        } else {
            text.textContent = 'Submitting...';
        }
    } else {
        btn.disabled = false;
        spinner.classList.add('hidden');
        if (button === 'run') {
            text.textContent = 'Run';
        } else {
            text.textContent = 'Submit';
        }
    }
}

// Show results panel
function showResultsPanel() {
    document.getElementById('results-panel').classList.remove('hidden');
}

// Show console output
function showConsoleOutput(message, type = 'info') {
    const consoleOutput = document.getElementById('console-output');
    const colors = {
        success: 'text-green-600',
        error: 'text-red-600',
        info: '#AAAFCB'
    };
    const color = colors[type] || '#5F4B35';
    if (typeof color === 'string' && color.startsWith('#')) {
        consoleOutput.innerHTML = `<p style="color: ${color};" class="font-semibold">${message}</p>`;
    } else {
        consoleOutput.innerHTML = `<p class="${color} font-semibold">${message}</p>`;
    }
}

// Display test case results
function displayTestResults(testcaseResults) {
    const output = document.getElementById('testcases-output');
    let html = '';
    
    testcaseResults.forEach((result, index) => {
        const testNum = index + 1;
        
        if (result.passed) {
            html += `
                <div class="test-result-item p-4 bg-green-50 border-l-4 border-green-500 rounded-lg">
                    <p class="font-semibold text-green-800">Test Case ${testNum}: Passed</p>
                </div>
            `;
        } else {
            html += `
                <div class="test-result-item p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                    <p class="font-semibold text-red-800 mb-2">Test Case ${testNum}: Failed</p>
                    ${result.error ? `<p class="text-sm text-red-600 mb-2">${result.error}</p>` : ''}
                    <div class="grid md:grid-cols-2 gap-3 mt-2">
                        <div>
                            <p class="text-xs font-semibold text-gray-600 mb-1">Input:</p>
                            <pre class="text-xs bg-gray-900 text-green-400 p-2 rounded border code-editor overflow-x-auto">${formatTestcaseValue(result.input)}</pre>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-gray-600 mb-1">Expected:</p>
                            <pre class="text-xs bg-gray-900 text-green-400 p-2 rounded border code-editor overflow-x-auto">${formatTestcaseValue(result.expected)}</pre>
                        </div>
                    </div>
                    ${result.actual !== undefined && result.actual !== null ? `
                        <div class="mt-2">
                            <p class="text-xs font-semibold text-gray-600 mb-1">Your Output:</p>
                            <pre class="text-xs bg-gray-900 text-green-400 p-2 rounded border code-editor overflow-x-auto">${formatTestcaseValue(result.actual)}</pre>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    });
    
    output.innerHTML = html;
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Format testcase value (input/expected) for display
function formatTestcaseValue(value) {
    if (!value) return '(not available)';
    try {
        // Try to parse as JSON and format nicely
        const parsed = JSON.parse(value);
        return escapeHtml(JSON.stringify(parsed, null, 2));
    } catch (e) {
        // If not JSON, display as-is
        return escapeHtml(String(value));
    }
}

// CLIENT-SIDE execution using Pyodide (fast, no server delay)
let pyodide = null;
async function initPyodide() {
    if (pyodide) return;
    try {
        pyodide = await loadPyodide();
    } catch (e) {
        console.error('Pyodide failed:', e);
    }
}

async function runCode() {
    if (isRunning || isSubmitting) return;
    const code = getCode().trim();
    if (!code) {
        showConsoleOutput('Please write some code first!', 'error');
        return;
    }
    
    isRunning = true;
    setLoading('run', true);
    showResultsPanel();
    showConsoleOutput('Running your code...', 'info');
    
    try {
        if (!pyodide) {
            showConsoleOutput('Loading Python runtime...', 'info');
            await initPyodide();
        }
        
        const testcases = sampleTestcases;
        const funcName = '{{ quiz.function_signature }}'.match(/def\s+(\w+)/)?.[1] || 'solution';
        const results = [];
        let passedCount = 0;
        
        for (let i = 0; i < testcases.length; i++) {
            const tc = testcases[i];
            try {
                pyodide.runPython(code);
                const inputData = JSON.parse(tc.input_data);
                const expected = JSON.parse(tc.expected_output);
                
                let result;
                if (Array.isArray(inputData) && inputData.length > 0) {
                    result = pyodide.runPython(`${funcName}(*${JSON.stringify(inputData)})`);
                } else {
                    result = pyodide.runPython(`${funcName}(${JSON.stringify(inputData)})`);
                }
                
                const actual = result.toJs ? result.toJs({dict_converter: Object.fromEntries}) : result;
                const passed = JSON.stringify(actual) === JSON.stringify(expected);
                
                results.push({
                    passed: passed,
                    error: passed ? null : 'Wrong Answer',
                    error_type: passed ? null : 'wrong_answer',
                    input: tc.input_data,
                    expected: tc.expected_output,
                    actual: JSON.stringify(actual)
                });
                
                if (passed) passedCount++;
                else break;
            } catch (e) {
                results.push({
                    passed: false,
                    error: `Runtime Error: ${e.message}`,
                    error_type: 'runtime_error',
                    input: tc.input_data,
                    expected: tc.expected_output,
                    actual: ''
                });
                break;
            }
        }
        
        const allPassed = passedCount === testcases.length;
        showConsoleOutput(
            allPassed ? `All ${testcases.length} passed!` : `Passed ${passedCount}/${testcases.length}`,
            allPassed ? 'success' : 'error'
        );
        displayTestResults(results);
        document.getElementById('results-panel').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        showConsoleOutput(`Error: ${error.message}`, 'error');
    } finally {
        isRunning = false;
        setLoading('run', false);
    }
}

// Pre-load Pyodide
initPyodide();

// Submit code (against all test cases)
async function submitCode() {
    if (isRunning || isSubmitting) return;
    
    const code = getCode().trim();
    if (!code) {
        showConsoleOutput('Please write some code first!', 'error');
        return;
    }
    
    if (!confirm('Submit your solution? This will be evaluated against all test cases.')) {
        return;
    }
    
    isSubmitting = true;
    setLoading('submit', true);
    showResultsPanel();
    showConsoleOutput('Submitting your solution...', 'info');
    
    try {
        const response = await fetch(`/student/quiz/${quizId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                language: document.getElementById('language').value
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showConsoleOutput(`Error: ${data.error}`, 'error');
            isSubmitting = false;
            setLoading('submit', false);
            return;
        }
        
        // Display results
        const allPassed = data.status === 'pass';
        const statusMsg = allPassed
            ? `Accepted! Passed ${data.passed_testcases}/${data.total_testcases} test cases.`
            : `Wrong Answer. Passed ${data.passed_testcases}/${data.total_testcases} test cases.`;
        
        showConsoleOutput(statusMsg, allPassed ? 'success' : 'error');
        
        if (data.error_message && !allPassed) {
            showConsoleOutput(`Error: ${data.error_message}`, 'error');
        }
        
        if (data.testcase_results && data.testcase_results.length > 0) {
            displayTestResults(data.testcase_results);
        }
        
        // Scroll to results
        document.getElementById('results-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Reload page after a delay to show updated submission status
        if (allPassed) {
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
        
    } catch (error) {
        console.error('Error:', error);
        showConsoleOutput('Error submitting solution. Please try again.', 'error');
    } finally {
        isSubmitting = false;
        setLoading('submit', false);
    }
}

// Event listeners
document.getElementById('run-btn').addEventListener('click', runCode);
document.getElementById('submit-btn').addEventListener('click', submitCode);
</script>
{% endblock %}
